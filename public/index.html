<!DOCTYPE html>
<html>
<head>
  <title>Chat App</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #chat-container { display: none; }
    #messages { border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px; margin-bottom: 10px; }
    #messages div { margin-bottom: 5px; }
    input { padding: 5px; margin-right: 5px; }
    button { padding: 5px; }
  </style>
</head>
<body>

  <div id="auth-container">
    <h2>Register</h2>
    <input id="reg-username" placeholder="Username">
    <input id="reg-password" type="password" placeholder="Password">
    <button onclick="register()">Register</button>
    <p>Or login:</p>
    <input id="login-username" placeholder="Username">
    <input id="login-password" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
    <p id="auth-message" style="color:red;"></p>
  </div>

  <div id="chat-container">
    <div>
      Logged in as <span id="current-user"></span>
      <button onclick="logout()">Logout</button>
    </div>
    <div id="messages"></div>
    <input id="message-input" placeholder="Type a message">
    <button onclick="sendMessage()">Send</button>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    let currentUser = null;

    // Registration
    async function register() {
      const username = document.getElementById('reg-username').value;
      const password = document.getElementById('reg-password').value;
      const msg = document.getElementById('auth-message');
      msg.textContent = '';

      if (!username || !password) { msg.textContent = 'Fill all fields'; return; }

      try {
        const res = await fetch('/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();

        if (res.ok) {
          currentUser = data.user;
          enterChat();
        } else {
          msg.textContent = data.error;
        }
      } catch (err) {
        console.error(err);
        msg.textContent = 'Server error';
      }
    }

    // Login
    async function login() {
      const username = document.getElementById('login-username').value;
      const password = document.getElementById('login-password').value;
      const msg = document.getElementById('auth-message');
      msg.textContent = '';

      if (!username || !password) { msg.textContent = 'Fill all fields'; return; }

      try {
        const res = await fetch('/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();

        if (res.ok) {
          currentUser = data.user;
          enterChat();
        } else {
          msg.textContent = data.error;
        }
      } catch (err) {
        console.error(err);
        msg.textContent = 'Server error';
      }
    }

    // Enter chat
    function enterChat() {
      document.getElementById('auth-container').style.display = 'none';
      document.getElementById('chat-container').style.display = 'block';
      document.getElementById('current-user').textContent = currentUser.username;
    }

    // Logout
    function logout() {
      currentUser = null;
      document.getElementById('auth-container').style.display = 'block';
      document.getElementById('chat-container').style.display = 'none';
      document.getElementById('messages').innerHTML = '';
      document.getElementById('auth-message').textContent = '';
      document.getElementById('reg-username').value = '';
      document.getElementById('reg-password').value = '';
      document.getElementById('login-username').value = '';
      document.getElementById('login-password').value = '';
    }

    // Socket.io chat
    socket.on('chat history', msgs => {
      const container = document.getElementById('messages');
      container.innerHTML = '';
      msgs.forEach(m => addMessage(m));
    });

    socket.on('chat message', msg => addMessage(msg));

    function sendMessage() {
      const input = document.getElementById('message-input');
      const text = input.value.trim();
      if (!text || !currentUser) return;

      const msg = { user: currentUser.username, text };
      socket.emit('chat message', msg);
      input.value = '';
    }

    function addMessage(msg) {
      const container = document.getElementById('messages');
      const div = document.createElement('div');
      div.textContent = `${msg.user}: ${msg.text}`;
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }
  </script>
</body>
</html>
