<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>User Profile</title>
<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    margin-top: 50px;
    background: #fafafa;
  }

  #profile {
    display: inline-block;
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }

  #profile img {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 10px;
  }

  #aboutMeInput {
    width: 300px;
    height: 80px;
    margin-top: 10px;
  }

  button {
    margin-top: 5px;
    padding: 5px 10px;
    cursor: pointer;
  }

  #saveMsg {
    color: green;
    margin-top: 5px;
  }

  #editNotice {
    color: #666;
    font-size: 0.9em;
    margin-top: 5px;
  }

  #logoutBtn {
    margin-top: 15px;
    background: #f44336;
    color: white;
    border: none;
    border-radius: 5px;
  }

  #backToChatBtn {
    margin-top: 10px;
    background: #2196F3;
    color: white;
    border: none;
    border-radius: 5px;
  }
</style>
</head>
<body>
<div id="profile">
  <img id="profilePic" src="https://via.placeholder.com/150" alt="Profile Picture">
  <h2 id="username"></h2>
  <p id="editNotice"></p>
  <p id="aboutMe"></p>
  <textarea id="aboutMeInput" placeholder="Write something about yourself..."></textarea><br>
  <button id="saveAboutBtn">Save</button>
  <div id="saveMsg"></div>
  <button id="logoutBtn" style="display:none;">Log Out</button>
  <button id="backToChatBtn" style="display:none;">Back to Chat</button>
</div>

<script>
const DEFAULT_PROFILE = 'https://via.placeholder.com/150';
let currentUser = null;

// Fetch current logged-in user info
async function getCurrentUser() {
  try {
    const res = await fetch('/api/me');
    if (res.ok) currentUser = await res.json();
  } catch (err) {
    console.error(err);
  }
}

async function loadProfile() {
  await getCurrentUser();
  const username = window.location.pathname.split('/').pop();
  const res = await fetch(`/api/user/${username}`);
  if (!res.ok) {
    document.getElementById('profile').innerHTML = '<p>User not found</p>';
    return;
  }

  const user = await res.json();
  document.getElementById('username').textContent = user.username;
  document.getElementById('profilePic').src = user.profile_url || DEFAULT_PROFILE;
  document.getElementById('aboutMe').textContent = user.about_me || 'This user hasn’t written anything yet.';

  const aboutInput = document.getElementById('aboutMeInput');
  const saveBtn = document.getElementById('saveAboutBtn');
  const saveMsg = document.getElementById('saveMsg');
  const editNotice = document.getElementById('editNotice');
  const logoutBtn = document.getElementById('logoutBtn');
  const backBtn = document.getElementById('backToChatBtn');

  // If viewing own profile
  if (currentUser && currentUser.username === user.username) {
    editNotice.textContent = "(Editing your profile)";
    aboutInput.value = user.about_me || '';
    aboutInput.style.display = 'block';
    saveBtn.style.display = 'inline-block';
    logoutBtn.style.display = 'inline-block';
    backBtn.style.display = 'inline-block';

    // Save About Me
    saveBtn.onclick = async () => {
      const aboutText = aboutInput.value;
      try {
        const updateRes = await fetch(`/api/user/${user.username}/about`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ about_me: aboutText })
        });
        if (updateRes.ok) {
          const updated = await updateRes.json();
          document.getElementById('aboutMe').textContent = updated.about_me || 'This user hasn’t written anything yet.';
          saveMsg.textContent = 'Saved successfully!';
          setTimeout(() => { saveMsg.textContent = ''; }, 2000);
        }
      } catch (err) {
        console.error(err);
        saveMsg.textContent = 'Error saving.';
        setTimeout(() => { saveMsg.textContent = ''; }, 2000);
      }
    };

    // Log out
    logoutBtn.onclick = async () => {
      await fetch('/logout', { method: 'POST' });
      window.location.href = '/';
    };

    // Back to Chat
    backBtn.onclick = () => {
      window.location.href = '/';
    };

  } else {
    // Viewing someone else's profile
    aboutInput.style.display = 'none';
    saveBtn.style.display = 'none';
    logoutBtn.style.display = 'none';
    backBtn.style.display = currentUser ? 'inline-block' : 'none';
    editNotice.textContent = '';
    if (currentUser) {
      backBtn.onclick = () => { window.location.href = '/'; };
    }
  }
}

loadProfile();
</script>
</body>
</html>
