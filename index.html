<!DOCTYPE html>
<html>
<head>
  <title>Simple Chat Room</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    ul { list-style-type: none; padding: 0; }
    li { padding: 8px; background: #eee; margin-bottom: 5px; border-radius: 4px; }
    input { padding: 10px; width: 80%; margin-bottom: 5px; }
    button { padding: 10px; margin-bottom: 5px; }
    #top-bar { display: flex; justify-content: space-between; align-items: center; }
    #username-display { font-weight: bold; }
    #form { display: none; margin-top: 10px; }
    #messages { display: none; margin-top: 10px; }
    #auth { margin-bottom: 20px; }
    #auth input { display: block; }
  </style>
</head>
<body>
  <div id="top-bar">
    <h1>Simple Chat Room</h1>
    <div>
      <span id="username-display"></span>
      <button id="logout-btn" style="display:none;">Logout</button>
    </div>
  </div>

  <div id="auth">
    <h2>Login or Register</h2>

    <div id="register-section">
      <h3>Register</h3>
      <input type="text" id="reg-username" placeholder="Username" />
      <input type="password" id="reg-password" placeholder="Password" />
      <button id="register-btn">Register</button>
      <p id="reg-msg"></p>
    </div>

    <div id="login-section">
      <h3>Login</h3>
      <input type="text" id="login-username" placeholder="Username" />
      <input type="password" id="login-password" placeholder="Password" />
      <button id="login-btn">Login</button>
      <p id="login-msg"></p>
    </div>
  </div>

  <ul id="messages"></ul>

  <form id="form" action="">
    <input id="input" autocomplete="off" placeholder="Type your message..." />
    <button>Send</button>
  </form>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    let username = localStorage.getItem('chatUsername') || '';

    const authDiv = document.getElementById('auth');
    const regUsername = document.getElementById('reg-username');
    const regPassword = document.getElementById('reg-password');
    const registerBtn = document.getElementById('register-btn');
    const regMsg = document.getElementById('reg-msg');

    const loginUsername = document.getElementById('login-username');
    const loginPassword = document.getElementById('login-password');
    const loginBtn = document.getElementById('login-btn');
    const loginMsg = document.getElementById('login-msg');

    const form = document.getElementById('form');
    const input = document.getElementById('input');
    const messages = document.getElementById('messages');
    const logoutBtn = document.getElementById('logout-btn');

    function showChatUI() {
      authDiv.style.display = 'none';
      form.style.display = 'flex';
      messages.style.display = 'block';
      logoutBtn.style.display = 'inline-block';
      document.getElementById('username-display').textContent = "You are: " + username;
    }

    function showAuthUI() {
      authDiv.style.display = 'block';
      form.style.display = 'none';
      messages.style.display = 'none';
      logoutBtn.style.display = 'none';
      username = '';
      localStorage.removeItem('chatUsername');
    }

    // Register
    registerBtn.addEventListener('click', async () => {
      const user = regUsername.value.trim();
      const pass = regPassword.value.trim();
      if (!user || !pass) return;

      try {
        const res = await fetch('/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: user, password: pass })
        });
        if (!res.ok) {
          const text = await res.text();
          regMsg.textContent = text;
          return;
        }
        const data = await res.json();
        username = data.user.username;
        localStorage.setItem('chatUsername', username);
        showChatUI();
      } catch (err) {
        regMsg.textContent = 'Error registering';
        console.error(err);
      }
    });

    // Login
    loginBtn.addEventListener('click', async () => {
      const user = loginUsername.value.trim();
      const pass = loginPassword.value.trim();
      if (!user || !pass) return;

      try {
        const res = await fetch('/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: user, password: pass })
        });
        if (!res.ok) {
          const text = await res.text();
          loginMsg.textContent = text;
          return;
        }
        const data = await res.json();
        username = data.user.username;
        localStorage.setItem('chatUsername', username);
        showChatUI();
      } catch (err) {
        loginMsg.textContent = 'Error logging in';
        console.error(err);
      }
    });

    // Logout
    logoutBtn.addEventListener('click', () => {
      showAuthUI();
    });

    // Chat form submission
    form.addEventListener('submit', function (e) {
      e.preventDefault();
      if (input.value && username) {
        socket.emit('chat message', { user: username, text: input.value });
        input.value = '';
      }
    });

    // Receive messages
    socket.on('chat message', function (msg) {
      const item = document.createElement('li');
      item.textContent = msg.user + ": " + msg.text;
      messages.appendChild(item);
      window.scrollTo(0, document.body.scrollHeight);
    });

    // If already logged in
    if (username) showChatUI();
  </script>
</body>
</html>
